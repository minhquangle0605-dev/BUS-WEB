<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách tuyến - Bus Route Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fas fa-bus"></i> Bus Finder</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link active" href="routes.html">Tuyến xe</a></li>
                    <li class="nav-item" id="navDashboard" style="display:none;">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item" id="navLogin"><a class="nav-link" href="login.html">Đăng nhập</a></li>
                    <li class="nav-item" id="navLogout" style="display:none;">
                        <a class="nav-link" href="#" onclick="handleLogout()">Đăng xuất</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="container">
            <h2 class="text-white mb-4"><i class="fas fa-route"></i> Danh sách tuyến xe</h2>
            <div id="routesList"></div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-ticket-alt"></i> Mua vé</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="purchaseForm">
                    <div class="modal-body">
                        <div id="routeInfo" class="mb-3"></div>
                        
                        <div class="mb-3">
                            <label class="form-label">Loại vé</label>
                            <select class="form-select" id="ticketType" required>
                                <option value="single">Vé lượt (2 giờ)</option>
                                <option value="day-pass">Vé ngày (24 giờ)</option>
                                <option value="week-pass">Vé tuần (7 ngày)</option>
                                <option value="month-pass">Vé tháng (30 ngày)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Loại hành khách</label>
                            <select class="form-select" id="passengerType" required>
                                <option value="regular">Người lớn (100%)</option>
                                <option value="student">Sinh viên (80%)</option>
                                <option value="senior">Người cao tuổi (50%)</option>
                            </select>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Vé sẽ được tạo QR code để quét khi lên xe
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="buyBtn">Mua vé</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentRoute = null;

        function handleLogout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                authAPI.logout();
            }
        }

        function updateNavbar() {
            if (isLoggedIn()) {
                document.getElementById('navDashboard').style.display = 'block';
                document.getElementById('navLogin').style.display = 'none';
                document.getElementById('navLogout').style.display = 'block';
            }
        }

        async function loadRoutes() {
            try {
                const result = await routeAPI.getAllRoutes();
                
                const html = result.routes.map(route => `
                    <div class="route-card mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="route-number me-3">${route.routeNumber}</span>
                                    <h5 class="mb-0">${route.routeName}</h5>
                                </div>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-map-marker-alt"></i> ${route.startPoint.name} 
                                    <i class="fas fa-arrow-right mx-2"></i> ${route.endPoint.name}
                                </p>
                                <p class="small mb-1">
                                    <i class="fas fa-route"></i> ${route.distance} km - 
                                    <i class="fas fa-clock"></i> ${route.estimatedDuration} phút
                                </p>
                                <p class="small text-success mb-0">
                                    <i class="fas fa-gift"></i> <strong>Miễn phí</strong> cho người cao tuổi trên 60 tuổi
                                </p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <h4 class="text-primary mb-3">${formatCurrency(route.pricing.regularPrice)}</h4>
                                <button class="btn btn-primary-custom btn-custom mb-2 w-100" onclick="showPurchaseModal('${route._id}')">
                                    <i class="fas fa-ticket-alt"></i> Mua vé online
                                </button>
                                <button class="btn btn-outline-secondary btn-custom w-100" onclick="showTicketOfficeInfo('${route._id}')">
                                    <i class="fas fa-store"></i> Quầy bán vé
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('routesList').innerHTML = html;
            } catch (error) {
                showAlert('Lỗi tải danh sách: ' + error.message, 'danger');
            }
        }

        async function showPurchaseModal(routeId) {
            if (!isLoggedIn()) {
                showAlert('Vui lòng đăng nhập để mua vé', 'warning');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            try {
                const result = await routeAPI.getRoute(routeId);
                currentRoute = result.route;

                document.getElementById('routeInfo').innerHTML = `
                    <h5>${currentRoute.routeName}</h5>
                    <p class="text-muted mb-1">Giá vé: ${formatCurrency(currentRoute.pricing.regularPrice)}</p>
                `;

                new bootstrap.Modal(document.getElementById('purchaseModal')).show();
            } catch (error) {
                showAlert('Lỗi: ' + error.message, 'danger');
            }
        }

        document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('buyBtn');
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);

                const data = {
                    routeId: currentRoute._id,
                    ticketType: document.getElementById('ticketType').value,
                    passengerType: document.getElementById('passengerType').value
                };

                const result = await ticketAPI.purchase(data);

                showAlert('Mua vé thành công! QR code đã được tạo', 'success');

                bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();

                setTimeout(() => window.location.href = 'dashboard.html', 1500);

            } catch (error) {
                hideLoading(btn, originalText);
                showAlert(error.message, 'danger');
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            updateNavbar();
            loadRoutes();
        });

        async function showTicketOfficeInfo(routeId) {
            try {
                const result = await routeAPI.getRoute(routeId);
                const route = result.route;
                
                const stopsWithOffice = route.busStops.filter(stop => 
                    stop.ticketOffice && stop.ticketOffice.available
                );
                
                if (stopsWithOffice.length === 0) {
                    showAlert('Tuyến này chưa có quầy bán vé. Vui lòng mua vé online.', 'info');
                    return;
                }
                
                const officesHTML = stopsWithOffice.map(stop => `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <h6 class="mb-2"><i class="fas fa-map-marker-alt text-primary"></i> ${stop.name}</h6>
                            <p class="mb-1 small text-muted">${stop.address.street}, ${stop.address.district}</p>
                            ${stop.ticketOffice.phoneNumber ? 
                                `<p class="mb-1 small"><i class="fas fa-phone text-success"></i> ${stop.ticketOffice.phoneNumber}</p>` : ''}
                            ${stop.ticketOffice.openingHours ? 
                                `<p class="mb-1 small"><i class="fas fa-clock text-warning"></i> 
                                T2-T6: ${stop.ticketOffice.openingHours.weekday} | 
                                T7-CN: ${stop.ticketOffice.openingHours.weekend}</p>` : ''}
                            ${stop.ticketOffice.services && stop.ticketOffice.services.length > 0 ?
                                `<p class="mb-0 small"><i class="fas fa-concierge-bell"></i> ${stop.ticketOffice.services.join(', ')}</p>` : ''}
                        </div>
                    </div>
                `).join('');
                
                const modalHTML = `
                    <div class="modal fade" id="officeModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-store"></i> Quầy bán vé - ${route.routeName}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-success">
                                        <i class="fas fa-gift"></i> <strong>Chính sách đặc biệt:</strong> 
                                        Người cao tuổi trên 60 tuổi được miễn phí vé (vui lòng mang theo CCCD/CMND)
                                    </div>
                                    <h6 class="mb-3">Các quầy bán vé trên tuyến:</h6>
                                    ${officesHTML}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove old modal if exists
                const oldModal = document.getElementById('officeModal');
                if (oldModal) oldModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                new bootstrap.Modal(document.getElementById('officeModal')).show();
                
            } catch (error) {
                showAlert('Lỗi tải thông tin: ' + error.message, 'danger');
            }
        }
    </script>
</body>
</html>
